#!/bin/bash -eux

case "$1" in
  -v|--version)
    version="$2"
esac

# Downloads and unzip GateIn Portal if it's not present in broker node
if [[ ! -d ${OPENSHIFT_HOMEDIR}/gatein-portal ]] ; then
  wget -P ${OPENSHIFT_HOMEDIR} http://downloads.jboss.org/gatein/Releases/Portal/3.6.0.Final/GateIn-3.6.0.Final-jbossas7.zip
  unzip ${OPENSHIFT_HOMEDIR}/GateIn-3.6.0.Final-jbossas7.zip -d ${OPENSHIFT_HOMEDIR}
  mv ${OPENSHIFT_HOMEDIR}/GateIn-3.6.0.Final-jbossas7 ${OPENSHIFT_HOMEDIR}/gatein-portal
fi

# Checks if gatein-portal is present in node
if [[ ! -d ${OPENSHIFT_HOMEDIR}/gatein-portal ]] ; then
  echo "GateIn Portal not found, GateIn cartridge cannot continue"
  exit 1  
fi

# Installs gatein-portal on cartridge
mkdir -p ${OPENSHIFT_GATEIN_DIR}/gatein-portal
cp -R ${OPENSHIFT_HOMEDIR}/gatein-portal/{appclient,bin,bundles,docs,domain,gatein,standalone,welcome-content} ${OPENSHIFT_GATEIN_DIR}/gatein-portal
ln -s ${OPENSHIFT_HOMEDIR}/gatein-portal/modules ${OPENSHIFT_GATEIN_DIR}/gatein-portal
ln -s ${OPENSHIFT_HOMEDIR}/gatein-portal/jboss-modules.jar ${OPENSHIFT_GATEIN_DIR}/gatein-portal

# Installs template
mkdir -p ${OPENSHIFT_GATEIN_DIR}/template/{deployments,extensions}